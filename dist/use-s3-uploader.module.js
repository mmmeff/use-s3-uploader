import{useMemo as t,useCallback as e,useEffect as n}from"react";import s from"mime-types";function r(t){return t.type||s.lookup(t.name)}var i=function(){function t(t){this.test=void 0,this.server=void 0,this.s3path=void 0,this.signingUrl=void 0,this.signingUrlMethod=void 0,this.successResponses=void 0,this.contentDisposition=void 0,this.uploadRequestHeaders=void 0,this.httprequest=void 0,this.signingUrlQueryParams=void 0,this.signingUrlHeaders=void 0,this.signingUrlWithCredentials=void 0,this.el=void 0,this.getSignedUrl=void 0,this.onProgress=function(t,e,n){return console.log("base.onProgress()",t,e)};var e=this;for(var n in e.test=!1,e.server="",e.signingUrl="/sign-s3",e.signingUrlMethod="GET",e.successResponses=[200,201],null==t&&(t={}),t)t.hasOwnProperty(n)&&(e[n]=t[n])}var e=t.prototype;return e.handle=function(t){for(var e=[],n=0;n<t.length;n++)this.onUploadStart(t[n],function(t){return console.log(this),this.onProgress(0,"Waiting",t),e.push(this.uploadFile(t)),e}.bind(this))},e.uploadFile=function(t){var e=this.uploadToS3.bind(this,t);return this.getSignedUrl?this.getSignedUrl(t,e):this.executeOnSignedUrl(t,e)},e.uploadToS3=function(t,e){var n=this.createCORSRequest("PUT",e.signedUrl);n?(n.onload=function(){return this.successResponses.indexOf(n.status)>=0?(this.onProgress(100,"Upload completed",t),this.onFinish(e,t)):this.onError("Upload error: "+n.status,t,this._getErrorRequestContext(n))}.bind(this),n.onerror=function(){return this.onError("XHR error",t,this._getErrorRequestContext(n))}.bind(this),n.upload.onprogress=function(e){var n;if(e.lengthComputable)return n=Math.round(e.loaded/e.total*100),this.onProgress(n,100===n?"Finalizing":"Uploading",t)}.bind(this)):this.onError("CORS not supported",t);var s=r(t),i={"content-type":s};if(this.contentDisposition){var o=this.contentDisposition;"auto"===o&&(o="image/"===s.substr(0,6)?"inline":"attachment");var a=this.scrubFilename(t.name);i["content-disposition"]=o+'; filename="'+a+'"'}return this.uploadRequestHeaders||n.setRequestHeader("x-amz-acl","public-read"),[e.headers,this.uploadRequestHeaders].filter(Boolean).forEach(function(t){Object.entries(t).forEach(function(t){i[t[0].toLowerCase()]=t[1]})}),Object.entries(i).forEach(function(t){n.setRequestHeader(t[0],t[1])}),this.httprequest=n,n.send(t)},e.createCORSRequest=function(t,e,n){n=n||{};var s=new XMLHttpRequest;return null!=s.withCredentials?(s.open(t,e,!0),null!=n.withCredentials&&(s.withCredentials=n.withCredentials)):s=null,s},e.executeOnSignedUrl=function(t,e){var n="?objectName="+this.scrubFilename(t.name)+"&contentType="+encodeURIComponent(r(t));if(this.s3path&&(n+="&path="+encodeURIComponent(this.s3path)),this.signingUrlQueryParams){var s="function"==typeof this.signingUrlQueryParams?this.signingUrlQueryParams():this.signingUrlQueryParams;Object.keys(s).forEach(function(t){n+="&"+t+"="+s[t]})}var i=this.createCORSRequest(this.signingUrlMethod,this.server+this.signingUrl+n,{withCredentials:this.signingUrlWithCredentials});if(this.signingUrlHeaders){var o="function"==typeof this.signingUrlHeaders?this.signingUrlHeaders():this.signingUrlHeaders;Object.keys(o).forEach(function(t){i.setRequestHeader(t,o[t])})}return i.overrideMimeType&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState&&this.successResponses.indexOf(i.status)>=0){var n;try{n=JSON.parse(i.responseText),this.onSignedUrl(n)}catch(e){return this.onError("Invalid response from server",t,this._getErrorRequestContext(i)),!1}return e(n)}if(4===i.readyState&&this.successResponses.indexOf(i.status)<0)return this.onError("Could not contact request signing server. Status = "+i.status,t,this._getErrorRequestContext(i))}.bind(this),i.send()},e.onFinish=function(t,e){return console.log("base.onFinish()",t.publicUrl)},e.onUploadStart=function(t,e){return console.log("base.onUploadStart()",t),e(t)},e.onError=function(t,e){return console.log("base.onError()",t)},e.onSignedUrl=function(t){},e.scrubFilename=function(t){return t.replace(/[^\w\d_\-\.]+/gi,"")},e.abortUpload=function(){this.httprequest&&this.httprequest.abort()},e._getErrorRequestContext=function(t){return{response:t.responseText,status:t.status,statusText:t.statusText,readyState:t.readyState}},t}(),o=function(s,r){var o=t(function(){return new i(s)},[s,r]),a=e(function(t,e){o.handle(t&&t.files||[])},[]);n(function(){var t,e=(t=r)?"function"==typeof t?t():"current"in t?t.current:t:void 0;return console.log(e),e.addEventListener("change",function(t){return a(e,t)}),function(){e.removeEventListener("change",function(t){return a(e,t)})}},[s,r])};export{o as useS3Uploader};

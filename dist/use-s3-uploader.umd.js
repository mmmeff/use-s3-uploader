!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("mime-types")):"function"==typeof define&&define.amd?define(["exports","react","mime-types"],t):t((e||self).useS3Uploader={},e.react,e.mimeTypes)}(this,function(e,t,n){function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=s(n);function r(e){return e.type||i.default.lookup(e.name)}var o=function(){function e(e){this.test=void 0,this.server=void 0,this.s3path=void 0,this.signingUrl=void 0,this.signingUrlMethod=void 0,this.successResponses=void 0,this.contentDisposition=void 0,this.uploadRequestHeaders=void 0,this.httprequest=void 0,this.signingUrlQueryParams=void 0,this.signingUrlHeaders=void 0,this.signingUrlWithCredentials=void 0,this.el=void 0,this.getSignedUrl=void 0,this.onProgress=function(e,t,n){return console.log("base.onProgress()",e,t)};var t=this;for(var n in t.test=!1,t.server="",t.signingUrl="/sign-s3",t.signingUrlMethod="GET",t.successResponses=[200,201],null==e&&(e={}),e)e.hasOwnProperty(n)&&(t[n]=e[n])}var t=e.prototype;return t.handle=function(e){for(var t=[],n=0;n<e.length;n++)this.onUploadStart(e[n],function(e){return console.log(this),this.onProgress(0,"Waiting",e),t.push(this.uploadFile(e)),t}.bind(this))},t.uploadFile=function(e){var t=this.uploadToS3.bind(this,e);return this.getSignedUrl?this.getSignedUrl(e,t):this.executeOnSignedUrl(e,t)},t.uploadToS3=function(e,t){var n=this.createCORSRequest("PUT",t.signedUrl);n?(n.onload=function(){return this.successResponses.indexOf(n.status)>=0?(this.onProgress(100,"Upload completed",e),this.onFinish(t,e)):this.onError("Upload error: "+n.status,e,this._getErrorRequestContext(n))}.bind(this),n.onerror=function(){return this.onError("XHR error",e,this._getErrorRequestContext(n))}.bind(this),n.upload.onprogress=function(t){var n;if(t.lengthComputable)return n=Math.round(t.loaded/t.total*100),this.onProgress(n,100===n?"Finalizing":"Uploading",e)}.bind(this)):this.onError("CORS not supported",e);var s=r(e),i={"content-type":s};if(this.contentDisposition){var o=this.contentDisposition;"auto"===o&&(o="image/"===s.substr(0,6)?"inline":"attachment");var a=this.scrubFilename(e.name);i["content-disposition"]=o+'; filename="'+a+'"'}return this.uploadRequestHeaders||n.setRequestHeader("x-amz-acl","public-read"),[t.headers,this.uploadRequestHeaders].filter(Boolean).forEach(function(e){Object.entries(e).forEach(function(e){i[e[0].toLowerCase()]=e[1]})}),Object.entries(i).forEach(function(e){n.setRequestHeader(e[0],e[1])}),this.httprequest=n,n.send(e)},t.createCORSRequest=function(e,t,n){n=n||{};var s=new XMLHttpRequest;return null!=s.withCredentials?(s.open(e,t,!0),null!=n.withCredentials&&(s.withCredentials=n.withCredentials)):s=null,s},t.executeOnSignedUrl=function(e,t){var n="?objectName="+this.scrubFilename(e.name)+"&contentType="+encodeURIComponent(r(e));if(this.s3path&&(n+="&path="+encodeURIComponent(this.s3path)),this.signingUrlQueryParams){var s="function"==typeof this.signingUrlQueryParams?this.signingUrlQueryParams():this.signingUrlQueryParams;Object.keys(s).forEach(function(e){n+="&"+e+"="+s[e]})}var i=this.createCORSRequest(this.signingUrlMethod,this.server+this.signingUrl+n,{withCredentials:this.signingUrlWithCredentials});if(this.signingUrlHeaders){var o="function"==typeof this.signingUrlHeaders?this.signingUrlHeaders():this.signingUrlHeaders;Object.keys(o).forEach(function(e){i.setRequestHeader(e,o[e])})}return i.overrideMimeType&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState&&this.successResponses.indexOf(i.status)>=0){var n;try{n=JSON.parse(i.responseText),this.onSignedUrl(n)}catch(t){return this.onError("Invalid response from server",e,this._getErrorRequestContext(i)),!1}return t(n)}if(4===i.readyState&&this.successResponses.indexOf(i.status)<0)return this.onError("Could not contact request signing server. Status = "+i.status,e,this._getErrorRequestContext(i))}.bind(this),i.send()},t.onFinish=function(e,t){return console.log("base.onFinish()",e.publicUrl)},t.onUploadStart=function(e,t){return console.log("base.onUploadStart()",e),t(e)},t.onError=function(e,t){return console.log("base.onError()",e)},t.onSignedUrl=function(e){},t.scrubFilename=function(e){return e.replace(/[^\w\d_\-\.]+/gi,"")},t.abortUpload=function(){this.httprequest&&this.httprequest.abort()},t._getErrorRequestContext=function(e){return{response:e.responseText,status:e.status,statusText:e.statusText,readyState:e.readyState}},e}();e.useS3Uploader=function(e,n){var s=t.useMemo(function(){return new o(e)},[e,n]),i=t.useCallback(function(e,t){s.handle(e&&e.files||[])},[]);t.useEffect(function(){var e,t=(e=n)?"function"==typeof e?e():"current"in e?e.current:e:void 0;return console.log(t),t.addEventListener("change",function(e){return i(t,e)}),function(){t.removeEventListener("change",function(e){return i(t,e)})}},[e,n])}});
